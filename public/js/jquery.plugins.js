// Generated by CoffeeScript 1.3.3

$.jsonrpc = function(method, params, success, failure, options) {
  var ajax;
  options = options || {};
  success = success || $.noop;
  failure = failure || function(errMsg, errCode) {
    console.error("Error " + errCode + ": " + errMsg);
  };
  ajax = {
    type: "POST",
    url: "/jsonrpc",
    processData: false,
    dataType: "json",
    data: JSON.stringify({
      jsonrpc: "2.0",
      method: method,
      params: params,
      id: 1
    }),
    success: function(result) {
      if (result.error !== undefined && result.error.message) {
        if (result.error.message.substr(0, 8) === "!logout:") {
          document.location = "/login";
        }
        return failure(result.error.message, result.error.code);
      }
      return success(result.result);
    },
    error: function(jqXHR, textStatus, errorThrown) {
      return failure(textStatus, 0);
    }
  };
  if (options.async !== undefined) {
    ajax.async = options.async;
  }
  return $.ajax(ajax);
};

$.jsonrpcSync = function(method, params, success, failure, options) {
  options = options || {};
  options.async = false;
  return $.jsonrpc(method, params, success, failure, options);
};

$.ajaxPanel = function(url, success, failure) {
  failure = failure || function(errMsg, errCode) {
    console.error("Error " + errCode + ": " + errMsg);
  };
  $.ajax({
    type: "GET",
    url: url,
    processData: false,
    success: success
  });
};

$.jade = {};

$.jade.getTemplate = function(url, success, options) {
  var fn, fnRaw;
  fnRaw = url.replace(/[\/-]/g, "_");
  fn = void 0;
  if (fnRaw.charAt(0) === "_") {
    fnRaw = fnRaw.substr(1);
  }
  fn = "views_" + fnRaw;
  if (document[fn] !== undefined) {
    return success(fn);
  }
  $.ajax({
    url: url + ".jade",
    dataType: "script",
    success: function() {
      fnRaw = url.replace(/[\/-]/g, "_");
      fn = void 0;
      if (fnRaw.charAt(0) === "_") {
        fnRaw = fnRaw.substr(1);
      }
      fn = "views_" + fnRaw;
      success(fn);
    },
    failure: function(error) {
      alert(error);
    }
  });
};

$.jade.renderSync = function(fn, obj, failure) {
  var attrs;
  attrs = function(o) {
    var r;
    r = " ";
    $.each(o, function(i, n) {
      r += i + "=\"" + n + "\"";
    });
    return r;
  };
  return document[fn](obj, attrs, (function(val) {
    return val;
  }), failure);
};

$.app = {};

$.app.growl = {};

$.app.growl.hide = function() {
  $(".task-status").removeClass("active").css("display", "none");
};

/*
@param type "success" or "error"
@param message HTML message (can be raw text)
*/


$.app.growl.show = function(type, message) {
  $.app.growl.hide();
  $(".task-status." + type).css("display", "block").addClass("active");
  $(".status-content h2").html(type).next().html(message);
};

$.app.state = {};

$.app.state.get = function(success, options) {
  $.jsonrpc("user/get-state", {}, (function(data) {
    if (data !== undefined) {
      $.app.state.current = data;
      if (success) {
        success();
      }
      $(document).ready(function() {
        $(this).trigger("restore");
      });
    }
  }), (function(error) {
    console.error(error);
  }), options);
};

$.app.state.restoreModule = function() {
  var module;
  module = (!$.app.state.current.modules.selected || $.app.state.current.modules.selected === "" ? "home" : $.app.state.current.modules.selected);
  module = module.replace("#", "");
  window.history.pushState("", module, "/" + module);
  $("#main-container").trigger("ajaxUnload");
  $.app.state.update("modules.selected", module);
  $.ajax("/modules/" + module + "?ajax=1", {
    success: function(data) {
      var modules;
      $("#ajax-container").html(data);
      $(".selected").removeClass("selected");
      $("#spine-inner nav li a#nav-" + module).parent().addClass("selected");
      $(".ajax-spinner").hide();
      modules = $.app.state.current.modules;
      if (modules[modules.selected] !== undefined && modules[modules.selected].panel !== undefined && (modules[modules.selected].panel.active != null)) {
        $.app.panel.show(modules[modules.selected].panel.active.url, modules[modules.selected].panel.active.options);
      }
    }
  });
};

$.app.state.restore = function() {
  $(document).ready(function() {
    if ($.app.state.current === undefined) {
      $.app.state.get(function() {
        if ($.app.state.current.modules !== undefined && $.app.state.current.modules.selected !== undefined) {
          $.app.state.restoreModule($.app.state.current.modules);
        }
      });
    }
  });
};

$.app.state.update = function(stateName, stateValue) {
  $.jsonrpc("user/update-state", {
    name: stateName,
    value: stateValue
  }, (function(result) {
    $.app.state.current = result;
  }), function(error) {
    console.error(error);
  });
};

$.app.panel = {};

$.app.panel.show = function(url, options) {
  var active;
  active = false;
  options = options || {};
  try {
    active = $.app.state.current.modules[$.app.state.current.modules.selected].panel.active;
  } catch (_) {
    console.warn("$.app.state.current.modules.panel is still not being returned!");
  }
  if (options.jsonrpcMethod === undefined) {
    options.jsonrpcMethod = "view" + url;
  }
  if (active && active.options.tabid === options.tabid) {
    if (options.temporary !== undefined) {
      $(".sectional-tabs").find(".temporary-panel-tab").remove();
      $(".ajax-panel-content").empty();
    }
    $(".standout-disabled").removeClass("standout-disabled").addClass("standout-tab");
    $(".sectional-tabs").restoreStandoutElement();
    $.app.panel.hide();
    return;
  }
  if (options.temporary === undefined && $(".sectional-tabs").find(".temporary-panel-tab").length) {
    $(".standout-disabled").removeClass("standout-disabled").addClass("standout-tab");
    $(".sectional-tabs").restoreStandoutElement();
    $(".sectional-tabs").find(".temporary-panel-tab").remove();
    $(".ajax-panel-content").empty();
  }
  $.jsonrpc(options.jsonrpcMethod, {}, function(obj) {
    $.jade.getTemplate(url, function(fn) {
      var $sectionPanel, $sectionalTabs;
      $sectionalTabs = $(".sectional-tabs");
      $sectionPanel = $("#section-panel");
      $.app.state.update("modules." + $.app.state.current.modules.selected + ".panel.active", {
        url: url,
        options: options
      });
      $sectionalTabs.find("li").removeClass("active").filter(".standout-tab").removeClass("standout-tab").addClass("standout-disabled");
      $sectionalTabs.find("#" + options.tabid).addClass("active");
      $sectionalTabs.reorderActiveElement();
      $sectionPanel.removeClass().addClass(options.panel_size);
      $(".ajax-panel-content").html($.jade.renderSync(fn, obj, function(err, file, line) {
        $(".ajax-panel-content").html("Error in " + file + " at line " + line + ": " + err);
      }));
      $(".x-panel").unbind("click").on("click", function(e) {
        e.preventDefault();
        $(".standout-disabled").removeClass("standout-disabled").addClass("standout-tab");
        $sectionalTabs.restoreStandoutElement();
        $(".sectional-tabs").find(".temporary-panel-tab").remove();
        $(".ajax-panel-content").empty();
        return $.app.panel.hide();
      });
    });
  });
};

$.app.panel.hide = function() {
  var $sectionPanel;
  $sectionPanel = $("#section-panel");
  if ($sectionPanel.hasClass("hidden")) {
    $sectionPanel.removeClass("hidden");
    $(this).addClass("active");
  } else {
    $sectionPanel.addClass("hidden");
    $(".sectional-tabs .active").removeClass("active");
  }
  $.app.state.update("modules." + $.app.state.current.modules.selected + ".panel.active", null);
};

$.fn.reorderActiveElement = function() {
  return this.children(".active").detach().prependTo(this);
};

$.fn.restoreStandoutElement = function() {
  return this.children(".standout-tab").detach().prependTo(this);
};
