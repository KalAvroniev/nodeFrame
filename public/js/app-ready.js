// Generated by CoffeeScript 1.3.3

$(document).ready(function() {
  var module;
  module = document.URL.substr(document.URL.lastIndexOf("/") + 1) || "home";
  if (module !== "") {
    $.app.state.update("modules.selected", module);
    $.app.state.get(function() {
      $.app.state.restoreModule();
    });
  }
  $("#ui-controls").on("click", "a", function(e) {
    var classNormalised, classes, isActive;
    classes = {
      condensed: "condensed",
      downgrade: "mobile",
      helpbubbles: "help"
    };
    classNormalised = classes[this.id.replace(/toggle|-/g, "")];
    isActive = $(this).hasClass("active");
    e.preventDefault();
    $(document.body).toggleClass(classNormalised);
    $(this).toggleClass("active");
    if (classNormalised === "help" && !isActive) {
      $(".help-bubble-container").show();
    }
    $.app.state.update("system_options.toggles." + this.id, $(this).hasClass("active"));
  });
  $("#toggle-condensed").toggleClass("active", $(document.body).hasClass("condensed"));
  $("#toggle-downgrade").toggleClass("active", $(document.body).hasClass("mobile"));
  $("#toggle-sys-menu").on("click", function(e) {
    e.preventDefault();
    $(this).add("#sys-menu").toggleClass("active");
  });
  $("#x-sys-menu").on("click", function(e) {
    e.preventDefault();
    $("#sys-menu, #toggle-sys-menu").removeClass("active");
  });
  $("#mode-rocker").on("click", function(e) {
    e.preventDefault();
    $("#system-rocker").find("h3").toggleClass("hidden");
    $(this).toggleClass("active");
    $.app.state.update("system_options.mode", $("#system-rocker").find("h3").not(".hidden").attr("id"));
  });
  if ($(document.body).hasClass("mobile")) {
    $("#notifications").addClass("native");
  }
  Scrollbars.add("notifications", $("#notifications").not(".native"), {
    lockscroll: false
  });
  $("#spine-inner").find("nav").find("a").mouseup(function() {
    $(this).removeClass("active");
  }).mousedown(function() {
    $(this).addClass("active");
  }).mouseout(function() {
    $(this).removeClass("active");
  });
  $(document).on("click", ".hide-all-bubbles", function(e) {
    e.preventDefault();
    $("#toggle-help-bubbles").trigger("click");
  });
  $(document).on("click", ".x-help-bubble", function(e) {
    e.preventDefault();
    $(this).closest(".help-bubble-container").hide();
  });
  $(".dropdown-toggle").dropdown();
  $(window).resize(function() {
    Scrollbars.update("notifications");
  });
  $("#system-help, #live-help-status, #live-help-info > a").on("click", function(e) {
    e.preventDefault();
    TaskStatus.show("error", "The Live Help system is coming soon.");
  });
  document.socketio = io.connect("http://" + location.host);
  document.socketio.on("logout", function() {
    document.location = "/login";
  });
  $.jsonrpc("notifications/fetch", {}, function(data) {
    var notif;
    notif = new NotificationsController(data.notifications);
    notif.render();
    document.socketio.on("notification", function(msg) {
      notif.notifications.unshift(msg.data);
      notif.render();
    });
  });
});
